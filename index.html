<html>
    <head>
        <meta http-equiv="content-type" content="text/html" charset="utf-8">
        <title>[FFXIV] HunterRecon</title>
        <meta name="description" content="HTML Overlay for FFXIV hunt information">
        <script src="https://apis.google.com/js/api.js"></script>
        <link rel="author" href="https://github.com/sappho192/HunterRecon">
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-nanum-barun-gothic@1.0.0/nanumbarungothic.min.css">
    </head>
    <body>
        <script>
            gapi.load('client', initClient);
            var alphabet = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N"];
            function initClient() {
                var API_KEY = 'AIzaSyAxFo4vumR9TLX-0-5zUaUbzXdY7mzDhOk';
                var CLIENT_ID = '17741540562-l3u3pptf45khhkpv103e7737imama9b1.apps.googleusercontent.com';

                var SCOPE = 'https://www.googleapis.com/auth/spreadsheets.readonly';

                gapi.client.init({
                    'apiKey': API_KEY,
                    'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    }).then(function() {
                    makeApiCall();
                });
            }
            function makeApiCall() {
                var params = {
                    spreadsheetId: '1p-X4AaYuLH2ounIzjKPBYeyFtzlHUgLRh8Xqt3aMaAY',
//                  range: 'B17:H30',
                    ranges: ["B17:H30", "J17:R22"], // 순서대로 A마물, S마물 정보
                    majorDimension: 'ROWS',
                };

                var request = gapi.client.sheets.spreadsheets.values.batchGet(params);
                request.then(function(response) {
//                    console.log(response.result);
                    updateTable(response.result);
                }, function(reason) {
                        console.error('error: ' + reason.result.error.message);
                });
            }
            function compareHunt(a, b) {
                if(parseFloat(a[2]) < parseFloat(b[2])) {
                    return 1;
                } if (parseFloat(a[2]) > parseFloat(b[2])) {
                    return -1;
                } return 0;
            }
            function updateTable(data) {
//                console.log(data);
                var tableArr = [];
                
                // A마물의 정보 수집
                var dataA = data.valueRanges["0"].values;
                var i;
                for(i = 0; i < dataA.length; i++)
                {
                    if(dataA[i].length == 7)
                    {// ["저지드라", "기계병정 슬립킨크스", "", " 07일 14:04 ~ 07일 16:24", "", "", "66%"]
                        var elem = new Array(3);
                        elem[0] = dataA[i][0];
                        elem[1] = dataA[i][1];
                        elem[2] = dataA[i][6];
                        tableArr.push(elem);
                    }
                    else if(dataA[i].length == 4)
                    {// 실종 or 젠대기
                        var elem = new Array(3);
                        elem[0] = dataA[i][0];
                        if(dataA[i][1].indexOf("실종") != -1) {
                            elem[1] = dataA[i][1].replace(" ▶실종◀","");
                            elem[2] = "실종";
                        }
                        else {
                            elem[1] = dataA[i][1];
                            elem[2] = "리젠중";
                        }
                        tableArr.push(elem);
                    }
                }
                
                // S마물의 정보 수집
                var dataS = data.valueRanges["1"].values;
                for(i = 0; i < dataS.length; i++)
                {
                    if(dataS[i].length == 9) // 4==젠중
                    {//["홍옥해", "오키나", "", " 07일 03:11 ~ 09일 07:11", "", "", "", "", "99%"]
                        var elem = new Array(3);
                        elem[0] = dataS[i][0];
                        elem[1] = dataS[i][1] + "(S)";
                        elem[2] = dataS[i][8];
                        tableArr.push(elem);
                    }
                }
                
                // 정렬
                tableArr.sort(compareHunt);
                
                // 표에 기록
                for(i = 0; i < 14; i++)
                {
                    document.getElementById(String(alphabet[i]+1)).innerHTML = tableArr[i][0];
                    document.getElementById(String(alphabet[i]+2)).innerHTML = tableArr[i][1];
                    var percentCell = document.getElementById(String(alphabet[i]+3));
                    if(tableArr[i][2].length > 3) {
                        percentCell.style.backgroundColor = "rgba(140,38,5,0.95)";
                    } else {
                        percentCell.style.backgroundColor = "rgba(5,38,87,1)";
                    }
                    percentCell.innerHTML = tableArr[i][2];
                }
            }
            
            setInterval(initClient, 30000);
        </script>
<!--    <div><input type="button" onclick="initClient();" value="수동갱신" /></div>-->
    <div id="huntDivA" style="width: 180px">
        <table id="huntTableA">
        <colgroup>
        <col style="width: 30%;">
        <col style="width: 65%;">
        <col style="width: 5%;">
        </colgroup>
          <tr>
            <th id="head" colspan="3">마물 시간표</th>
          </tr>
          <tr>
            <td id='A1'></td>
            <td id='A2'></td>
            <td id='A3'></td>
          </tr>
          <tr>
            <td id='B1'></td>
            <td id='B2'></td>
            <td id='B3'></td>
          </tr>
          <tr>
            <td id='C1'></td>
            <td id='C2'></td>
            <td id='C3'></td>
          </tr>
          <tr>
            <td id='D1'></td>
            <td id='D2'></td>
            <td id='D3'></td>
          </tr>
          <tr>
            <td id='E1'></td>
            <td id='E2'></td>
            <td id='E3'></td>
          </tr>
          <tr>
            <td id='F1'></td>
            <td id='F2'></td>
            <td id='F3'></td>
          </tr>
          <tr>
            <td id='G1'></td>
            <td id='G2'></td>
            <td id='G3'></td>
          </tr>
          <tr>
            <td id='H1'></td>
            <td id='H2'></td>
            <td id='H3'></td>
          </tr>
          <tr>
            <td id='I1'></td>
            <td id='I2'></td>
            <td id='I3'></td>
          </tr>
          <tr>
            <td id='J1'></td>
            <td id='J2'></td>
            <td id='J3'></td>
          </tr>
          <tr>
            <td id='K1'></td>
            <td id='K2'></td>
            <td id='K3'></td>
          </tr>
          <tr>
            <td id='L1'></td>
            <td id='L2'></td>
            <td id='L3'></td>
          </tr>
          <tr>
            <td id='M1'></td>
            <td id='M2'></td>
            <td id='M3'></td>
          </tr>
          <tr>
            <td id='N1'></td>
            <td id='N2'></td>
            <td id='N3'></td>
          </tr>
        </table>
    </div>
    </body>
</html>
